nal Input Core 総合設計・実装仕様書 (v1.1) を生成します。
変更点は主に 「3. 共通仕様」へのモード定義追加 と、「4. Android 実装詳細」への動的フラグ切替ロジックの追加 です。
KMP Terminal Input Core: 総合設計および実装仕様書
Version: 1.1.0
Date: 2025-12-28
Scope: Android/iOS Input Abstraction for Terminal Emulation
1. プロジェクト概要
1.1 目的
本ライブラリは、Android/iOS のネイティブ入力システム（IME、予測変換、ソフトウェアキーボード）およびハードウェアキーボード入力を抽象化し、以下の多様なバックエンドが利用可能な**「標準化されたxterm準拠バイトストリーム」**を生成する KMP ミドルウェアである。
1.2 対応ユースケース
 * Classic Terminal: SSH (Vim, Shell) の Raw 入力（予測変換なし）。
  * Modern AI Terminal: Claude Code 等の自然言語入力（予測変換、音声入力、フリック入力活用）。
  2. システムアーキテクチャ
  Adapter Pattern を採用し、プラットフォーム依存のイベントを共通の「アクション」に正規化する。
   * Platform View Layer: OS固有イベント (InputConnection 等) の受領。
    * Adapter Layer: OSの挙動を吸収し、共通インターフェースへ委譲。
       * Android: TerminalInputConnection (Stateless/Dummy Mode)
          * iOS: UITextInput Wrapper
           * Core Layer: 状態管理、ANSIエンコーディング。
            * Output Layer: ptyInputStream (Flow<ByteArray>).
            3. 共通仕様 (Common Core)
            3.1 InputMode 定義
            アプリケーションの文脈に応じて、入力システムの挙動を定義する。
            enum class InputMode {
                /**
                     * Raw Mode (Default):
                          * SSH, Vim, Shell操作向け。
                               * 予測変換、オートコレクト、自動大文字変換を無効化し、即時反応を優先する。
                                    */
                                        RAW,

                                            /**
                                                 * Text Mode:
                                                      * AIチャット、自然言語プロンプト向け。
                                                           * IMEの予測変換、フリック入力、音声入力を有効化する。
                                                                */
                                                                    TEXT
                                                                    }

                                                                    3.2 TerminalInputDispatcher インターフェース
                                                                    アダプターからコアロジックへの通信路。
                                                                    interface TerminalInputDispatcher {
                                                                        fun commitText(text: String)
                                                                            fun setComposingText(text: String, cursorIndex: Int)
                                                                                fun sendSpecialKey(key: VirtualKey)
                                                                                    fun sendControlKey(baseChar: Char)
                                                                                    }

                                                                                    4. Android 実装詳細
                                                                                    4.1 設計方針: Stateless Dummy Mode
                                                                                    モードに関わらず、TerminalInputConnection は 「IME を単なる入力パイプラインとして扱い、過去の状態（Editable）を持たせない」 設計を維持する。Text Mode においても、ターミナルの出力バッファ（プロンプトや色コードを含む文字列）を IME に読み取らせることは誤動作の原因となるためである。
                                                                                    4.2 TerminalInputConnection 実装
                                                                                    BaseInputConnection を継承し、Dummy Mode (fullEditor = false) で初期化する。
                                                                                    class TerminalInputConnection(
                                                                                        targetView: View,
                                                                                            private val dispatcher: TerminalInputDispatcher
                                                                                            ) : BaseInputConnection(targetView, false) { // 常に false

                                                                                                // ... (commitText, setComposingText, deleteSurroundingText の実装は v1.0 と同様) ...
                                                                                                    // Text Mode であっても、確定した文字列(commitText)をただちに dispatcher へ流す挙動は変わらない。
                                                                                                    }

                                                                                                    4.3 InputMode による動的切替ロジック (New)
                                                                                                    EditorInfo のフラグを InputMode に応じて動的に書き換える。Android では InputConnection 生成後のフラグ変更ができないため、restartInput による再接続を行う。
                                                                                                    TerminalView 実装仕様
                                                                                                    class TerminalView(context: Context) : View(context) {
                                                                                                        
                                                                                                            private val inputCore = TerminalInputCore()
                                                                                                                private var currentInputMode: InputMode = InputMode.RAW // 初期値

                                                                                                                    // モード切替メソッド (UIボタンやエスケープシーケンス解析から呼ぶ)
                                                                                                                        fun setInputMode(mode: InputMode) {
                                                                                                                                if (currentInputMode != mode) {
                                                                                                                                            currentInputMode = mode
                                                                                                                                                        
                                                                                                                                                                    // 重要: InputMethodManager に再接続を要求する
                                                                                                                                                                                // これにより onCreateInputConnection が再度呼び出される
                                                                                                                                                                                            val imm = context.getSystemService(Context.INPUT_METHOD_SERVICE) as InputMethodManager
                                                                                                                                                                                                        imm.restartInput(this)
                                                                                                                                                                                                                }
                                                                                                                                                                                                                    }

                                                                                                                                                                                                                        override fun onCreateInputConnection(outAttrs: EditorInfo): InputConnection {
                                                                                                                                                                                                                                // 共通設定
                                                                                                                                                                                                                                        outAttrs.imeOptions = EditorInfo.IME_FLAG_NO_EXTRACT_UI

                                                                                                                                                                                                                                                // モード別設定
                                                                                                                                                                                                                                                        when (currentInputMode) {
                                                                                                                                                                                                                                                                    InputMode.RAW -> {
                                                                                                                                                                                                                                                                                    // 厳格なターミナルモード: 予測・補完・学習を全カット
                                                                                                                                                                                                                                                                                                    outAttrs.inputType = InputType.TYPE_CLASS_TEXT or 
                                                                                                                                                                                                                                                                                                                                         InputType.TYPE_TEXT_FLAG_NO_SUGGESTIONS or
                                                                                                                                                                                                                                                                                                                                                                              InputType.TYPE_TEXT_VARIATION_VISIBLE_PASSWORD // 強力な補完無効化ハック
                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                      InputMode.TEXT -> {
                                                                                                                                                                                                                                                                                                                                                                                                                      // 自然言語モード: 標準的なテキスト入力として振る舞う
                                                                                                                                                                                                                                                                                                                                                                                                                                      // 音声入力キーなども表示されるようになる
                                                                                                                                                                                                                                                                                                                                                                                                                                                      outAttrs.inputType = InputType.TYPE_CLASS_TEXT or
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           InputType.TYPE_TEXT_FLAG_CAP_SENTENCES or // 文頭大文字
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                InputType.TYPE_TEXT_FLAG_AUTO_CORRECT    // 自動修正
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // 必要に応じて送信アクションを設定
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // outAttrs.imeOptions = EditorInfo.IME_ACTION_SEND 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // Connection 自体はモードに依存せず共通のものを使用
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return TerminalInputConnection(this, inputCore.dispatcher)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // ... (onKeyDown / HardwareKeyHandler の委譲処理は変更なし) ...
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            4.4 補足: Hardware Key Handler と共存
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Text Mode においても、HardwareKeyHandler (onKeyDown 委譲) は有効のままとする。これにより、Bluetoothキーボード接続時に「文章を打ちながら Ctrl+C で中断する」といった操作が可能になる。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            5. iOS 実装方針
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            iOS においても同様に、UITextInputTraits プロトコルを通じてモード切替を実装する。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * RAW Mode: autocorrectionType = .no, smartQuotesType = .no
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * TEXT Mode: autocorrectionType = .yes, smartQuotesType = .yes (またはデフォルト)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * 切替時: reloadInputViews() を呼び出し、設定を反映させる。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               6. 公開 API (Public Interface)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               interface TerminalInputHandler {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   fun attach(scope: CoroutineScope)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       fun detach()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           // ターミナル制御設定
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               fun setCursorMode(mode: CursorMode)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   fun setBracketedPasteMode(enabled: Boolean)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       // ★ 入力モード切替 (New)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           // Claude Code 等のユースケース向けに、UI層から明示的に切り替える
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               fun setInputMode(mode: InputMode)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   // 外部入力注入
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       fun injectKey(key: VirtualKey, modifiers: Set<Modifier> = emptySet())
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           fun injectString(text: String)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               // 出力ストリーム
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   val ptyInputStream: Flow<ByteArray>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       // UI状態
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           val uiState: StateFlow<InputUiState>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           7. まとめ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           本仕様により、ライブラリは以下の要件を同時に満たす。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * Vim/SSH の堅牢性: RAW モードにおける予測変換の完全排除と、Dummy Mode による状態不整合の防止。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * Modern UI の柔軟性: TEXT モードへの動的切替による、IME（予測・フリック・音声）のフル活用。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * 実装のシンプルさ: InputConnection のロジック自体は変更せず、EditorInfo フラグの操作のみでモード差分を吸収する。

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              :wq






